var G=typeof document!=="undefined"&&typeof window!=="undefined";function N(Q){Q=Q.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");let W=new RegExp("[\\?&]"+Q+"=([^&#]*)").exec(window.location.search);return W===null?"":decodeURIComponent(W[1].replace(/\+/g," "))}function E(){return window.location.search.substring(1).split("&").reduce((X,W)=>{if(!W)return X;let[Y,Z]=W.split("=");return X[decodeURIComponent(Y)]=decodeURIComponent(Z||""),X},{})}function z(){console.log("URL debugging:",{fullUrl:window.location.href,protocol:window.location.protocol,hostname:window.location.hostname,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash});let Q=window.location.pathname.replace(/^\/|\/$/g,"");if(!Q)return"home";let W=(Q.split("/").pop()||"").replace(/[^a-zA-Z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return console.log("Generated page slug:",W||"home"),W||"home"}function w(Q){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(Q)}function j(Q,X){let W={...Q};if(!X)return W;return Object.keys(X).forEach((Y)=>{let Z=W[Y],_=X[Y];if(Array.isArray(Z)&&Array.isArray(_))W[Y]=[...new Set([...Z,..._])];else if(typeof Z==="object"&&Z!==null&&typeof _==="object"&&_!==null&&!Array.isArray(Z)&&!Array.isArray(_))W[Y]=j(Z,_);else if(_!==void 0)W[Y]=_}),W}class R{baseUrl="https://funnels-api.awesomely.com/api/keap";getTrackingData(){let Q=E();try{let X=localStorage.getItem("LandingPagePath");if(X)console.log("Found LandingPagePath in localStorage:",X),Q.landing_page_path=X}catch(X){console.warn("Error accessing localStorage:",X)}return Q}async makeRequest(Q,X,W){console.log(`Making API request to ${Q}:`,{method:X,data:W});let Z=await(await fetch(`${this.baseUrl}${Q}`,{method:X,headers:{"Content-Type":"application/json"},body:W?JSON.stringify(W):void 0})).json();return console.log(`API Response from ${Q}:`,Z),Z}async checkSessionValidity(Q){return this.makeRequest(`/check-session-validity?session_key=${Q}`,"GET")}async startSession(Q){return this.makeRequest("/start-payments-api-session?phone_optional=true","POST",Q)}createContactInformationPayload(Q,X,W,Y){let Z={page_slug:z(),opt_in:!0,opt_in_reason:"Opted in via order form",tracking_data:this.getTrackingData(),sales_awesomely_external_key:W};if(!X){let _={first_name:Q.firstName,last_name:Q.lastName,email:Q.email,phone:Q.phone};console.log("No session key found. Using form data:",_),Object.assign(Z,_)}else console.log("Session key found:",X),Z.session_key=X;if(Y)Z.affiliate_id=Y;return Z}async updateContact(Q,X){return this.makeRequest(`/contacts/${Q}`,"PUT",X)}async createOrder(Q){return this.makeRequest("/create-and-charge-order","POST",Q)}async startSimpleSession(Q,X){let W={contact_id:Q,page_slug:X,opt_in:!0,opt_in_reason:"Opted in via order form",tracking_data:this.getTrackingData()};return console.log("Starting simple session with payload:",W),this.makeRequest("/start-payments-api-session","POST",W)}async getContactData(Q){return console.log("Fetching contact data for ID:",Q),this.makeRequest(`/contacts/${Q}`,"GET")}async getSessionKey(Q){return console.log("Getting session key for contact ID:",Q),this.makeRequest("/get-session-key","POST",{contact_id:Q})}}var F=R;class A{config;state;initialized=!1;keapClient;handlePaymentMessage=async()=>{};paymentResponseTimeout=null;pendingProductId=null;static defaultConfig={selectors:{acceptButton:"#tmp_button-11126-188",acceptButton2:"#tmp_button-79590-119",acceptButtonProduct2:"#product-2-button",rejectButton:"#link-94268",paymentContainer:"#payment-container",modal:"#oto-decline-modal",modalSubmitButton:"#retry-payment-submit"},sessionConfig:{expirationHours:2,storageKey:"orderSession"}};constructor(){if(this.config=j(A.defaultConfig,window.KeapOTOConfig||{}),this.state={keapContactId:null,orderId:null,sessionKey:null,urlFriendlySessionKey:null,acceptUrl:null,rejectUrl:null,existingPaymentMethodId:null,stepProducts:null,primaryProductId:null,secondaryProductId:null,contactId:null},this.keapClient=new F,G)window.simulatePaymentDecline=(Q=!0)=>{window._simulatePaymentDeclineEnabled=Q,console.log(`Payment decline simulation ${Q?"ENABLED":"DISABLED"}`),console.log("The next payment attempt will "+(Q?"simulate a decline":"process normally"))},window.simulateRetryPayment=(Q=!0)=>{if(Q===null){window._simulateRetryPaymentConfig=void 0,console.log("%c\uD83D\uDD27 TESTING: Retry payment simulation DISABLED","color: gray; font-weight: bold");return}window._simulateRetryPaymentConfig={enabled:!0,shouldSucceed:Q},console.log(`%c\uD83D\uDD27 TESTING: Retry payment simulation ENABLED (will ${Q?"SUCCEED":"FAIL"} after 3 seconds)`,"color: purple; font-weight: bold"),console.log("Use this to test the payment retry flow without actually processing a payment"),console.log("To test: Click any payment button, then submit the payment form in the retry modal"),console.log("To disable simulation: simulateRetryPayment(null)"),this.showPaymentRetryModal()}}init(){if(this.initialized=!1,G)document.addEventListener("DOMContentLoaded",()=>{this.checkSessionKey(),this.setupButtonHandlers(),this.initialized=!0});else console.log("Not running in browser environment. Initialization skipped.")}isSessionExpired(Q){let X=this.config.sessionConfig.expirationHours*60*60*1000;return new Date().getTime()-Q>X}deleteExpiredSessionData(){try{localStorage.removeItem(this.config.sessionConfig.storageKey),sessionStorage.removeItem(this.config.sessionConfig.storageKey),console.log("Deleted expired order session from storage")}catch(Q){console.warn("Failed to delete expired order session from storage",Q)}}getOrderSession(){let Q=null;try{let X=localStorage.getItem(this.config.sessionConfig.storageKey);if(X)Q=JSON.parse(X);if(!Q||this.isSessionExpired(Q.timestamp||0)){let W=sessionStorage.getItem(this.config.sessionConfig.storageKey);if(W)Q=JSON.parse(W)}if(Q&&this.isSessionExpired(Q.timestamp||0))return console.log("Order session expired",Q),this.deleteExpiredSessionData(),null;return Q}catch(X){return console.warn("Failed to retrieve order session from storage",X),null}}saveOrderSession(Q){let X={...Q,timestamp:new Date().getTime()};try{localStorage.setItem(this.config.sessionConfig.storageKey,JSON.stringify(X)),sessionStorage.setItem(this.config.sessionConfig.storageKey,JSON.stringify(X)),console.log("Order session saved to storage",X)}catch(W){console.warn("Failed to save order session to storage",W)}}checkSessionKey(){let Q=N("session_key"),X=this.getOrderSession();if(this.state.sessionKey=Q||(X?X.sessionKey:null),this.state.contactId=X?X.contactId:null,!this.state.sessionKey){console.error("No session key found. Upsell page requires a session key."),alert("Session not found. Please return to the main order page.");return}let W=z();this.fetchPageData(W)}async fetchPageData(Q){try{let X={page_slug:Q,session_key:this.state.sessionKey||"",tracking_data:{}};try{let W=await this.keapClient.makeRequest("/start-payments-api-session","POST",X);if(console.log("API Response:",W),W.is_duplicate===!0){if(console.warn("Duplicate order detected"),W.step&&W.step.next_step_url){let Y=W.step.next_step_url,Z=W.order?.url_friendly_session_key||this.state.sessionKey||"";setTimeout(()=>{window.location.href=`${Y}?session_key=${Z}`},3000)}return}this.updateState(W)}catch(W){if(W.status===400&&W.message==="Session has expired")console.log("Received expired session error from API"),this.deleteExpiredSessionData();throw W}}catch(X){console.error("API request failed:",X)}}updateState(Q){if(Q.contact&&Q.contact.id)this.state.keapContactId=Q.contact.keap_contact_id?.toString()||"";if(Q.order)this.state.orderId=Q.order.id?.toString()||null,this.state.sessionKey=Q.order.session_key||null,this.state.urlFriendlySessionKey=Q.order.url_friendly_session_key||null;if(Q.step)this.state.acceptUrl=Q.step.next_step_url||null,this.state.rejectUrl=Q.step.rejected_step_url||null;if(Q.payment&&Q.payment.payment_method_id)this.state.existingPaymentMethodId=Q.payment.keap_payment_method_id||null,console.log("Found existing payment method ID:",this.state.existingPaymentMethodId);if(Q.step&&Q.step.products){this.state.stepProducts=Q.step.products;let X=this.state.stepProducts?.find((Y)=>Y.position==="primary"),W=this.state.stepProducts?.find((Y)=>Y.position==="secondary");this.state.primaryProductId=X?X.id:null,this.state.secondaryProductId=W?W.id:null}}setupButtonHandlers(){let Q=document.getElementById(this.config.selectors.acceptButton);if(Q){let Z=Q.querySelector("a");if(Z instanceof HTMLElement)Z.addEventListener("click",(_)=>{_.preventDefault(),this.disableButton(Q,Z),this.handleAcceptClick()});else console.error("Primary accept button link not found within:",this.config.selectors.acceptButton)}else console.error("Primary accept button with ID",this.config.selectors.acceptButton,"not found");let X=document.getElementById(this.config.selectors.acceptButton2);if(X){let Z=X.querySelector("a");if(Z instanceof HTMLElement)Z.addEventListener("click",(_)=>{_.preventDefault(),this.disableButton(X,Z),this.handleAcceptClick()});else console.error("Secondary accept button link not found within:",this.config.selectors.acceptButton2)}else console.warn("Secondary accept button with ID",this.config.selectors.acceptButton2,"not found - this is optional");let W=document.getElementById(this.config.selectors.acceptButtonProduct2);if(W){let Z=W.querySelector("a");if(Z instanceof HTMLElement)Z.addEventListener("click",(_)=>{_.preventDefault(),this.disableButton(W,Z),this.handleProduct2AcceptClick()});else console.error("Second product accept button link not found within:",this.config.selectors.acceptButtonProduct2)}else console.warn("Second product accept button with ID",this.config.selectors.acceptButtonProduct2,"not found - this is optional");let Y=document.getElementById(this.config.selectors.rejectButton);if(Y)Y.addEventListener("click",()=>{this.handleRejectClick()});else console.error("Reject button with ID",this.config.selectors.rejectButton,"not found")}handleAcceptClick(){this.processPayment(this.state.primaryProductId)}handleProduct2AcceptClick(){this.processPayment(this.state.secondaryProductId)}handleRejectClick(){let Q=`?session_key=${this.state.urlFriendlySessionKey||""}`;if(this.state.rejectUrl)window.location.href=this.state.rejectUrl+Q;else if(console.warn("No reject URL found"),this.state.acceptUrl)window.location.href=this.state.acceptUrl+Q;else alert("Error: Could not determine the next page. Please contact support.")}processPayment(Q){if(!Q){console.error("No product ID provided for payment processing");return}if(this.state.existingPaymentMethodId){if(window._simulatePaymentDeclineEnabled)console.log("SIMULATING PAYMENT DECLINE (testing mode)");console.log("Using existing payment method ID:",this.state.existingPaymentMethodId),this.processPaymentWithMethodId(this.state.existingPaymentMethodId,Q);return}console.error("No payment method ID found for this session")}async processPaymentWithMethodId(Q,X){let W=z(),Y=[];if(this.pendingProductId=X,X!==null)Y.push(X);else if(this.state.primaryProductId!==null)Y.push(this.state.primaryProductId);else if(this.state.stepProducts&&Array.isArray(this.state.stepProducts)&&this.state.stepProducts.length>0)Y.push(this.state.stepProducts[0].id);if(Y.length===0){console.error("No products found to add to the order");return}let Z=N("affiliate"),_={payment_method_id:Q,page_slug:W,product_ids:Y};if(this.state.keapContactId)_.contact_id=this.state.keapContactId;if(this.state.sessionKey)_.session_key=this.state.sessionKey;if(Z)_.affiliate_id=Z;if(window._simulatePaymentDeclineEnabled)console.log("SIMULATING PAYMENT DECLINE (testing mode)"),_.status="declined",window._simulatePaymentDeclineEnabled=!1;try{try{let $=await this.keapClient.createOrder(_);if(console.log("Order created:",$),$.payment_status==="failed"||$.payment_status==="declined"||$.payment_status==="error"){console.warn(`Payment ${$.payment_status}: ${$.error||$.message||"Unknown reason"}`),this.showPaymentRetryModal();return}let J=`?session_key=${this.state.urlFriendlySessionKey||""}`;if($.is_duplicate===!0){if(console.warn("Duplicate order detected"),$.next_step_url)setTimeout(()=>{window.location.href=$.next_step_url+J},3000);else if($.step&&$.step.next_step_url)setTimeout(()=>{window.location.href=($.step?.next_step_url||"")+J},3000);return}let q=null;if($.next_step_url)q=$.next_step_url;else if($.step&&$.step.next_step_url)q=$.step.next_step_url;else if(this.state.acceptUrl)q=this.state.acceptUrl;if(q)setTimeout(()=>{window.location.href=q+J},3000);else console.warn("No next step URL found")}catch($){if($.status===400){if($.message==="Session expired")console.log("Session expired during payment process"),this.deleteExpiredSessionData()}throw $}}catch($){console.error("API request failed:",$),this.showPaymentRetryModal()}}async showPaymentRetryModal(){console.log("Showing payment retry modal");let Q=document.querySelector(this.config.selectors.modal);if(!Q){Q=document.createElement("dialog"),Q.id=this.config.selectors.modal.substring(1),Q.innerHTML=`
        <div class="closeLPModal"><img src="https://www.clickfunnels.com/images/closemodal.png" alt=""></div>
        <h2>Your credit card was declined, please update your card.</h2>
        <div id="keap-payment-method-container">
          <keap-payment-method id="keap-payment-method" />
        </div>
        <button id="${this.config.selectors.modalSubmitButton.substring(1)}" class="elButton">Click To Continue</button>
      `,document.body.appendChild(Q);let X=Q.querySelector(".closeLPModal");if(X)X.addEventListener("click",()=>{Q?.close()})}Q.showModal(),this.updateButtonHandlersForRetry();try{if(!this.state.keapContactId){console.error("Contact ID is missing, cannot get session key");return}let X=await this.keapClient.getSessionKey(this.state.keapContactId);console.log("Got new session key for payment retry:",X),await this.setupPaymentRetryForm(X.session_key)}catch(X){console.error("Failed to set up payment retry form:",X)}}updateButtonHandlersForRetry(){console.log("Updating button handlers for payment retry"),this.updateSingleButtonHandler(this.config.selectors.acceptButton),this.updateSingleButtonHandler(this.config.selectors.acceptButton2),this.updateSingleButtonHandler(this.config.selectors.acceptButtonProduct2)}updateSingleButtonHandler(Q){let X=document.getElementById(Q);if(!X)return;let W=X.querySelector("a");if(!W||!(W instanceof HTMLElement))return;if(X.style.pointerEvents="",W.style.pointerEvents="",W.style.opacity="",W.style.cursor="",W.classList.remove("disabled"),W.dataset.originalBgColor)W.style.background=W.dataset.originalBgColor;else W.style.background="";let Y=W.querySelector(".elButtonMain");if(Y instanceof HTMLElement){if(W.dataset.originalText)Y.textContent=W.dataset.originalText}let Z=W.cloneNode(!0);W.parentNode?.replaceChild(Z,W),Z.addEventListener("click",(_)=>{_.preventDefault();let $=document.querySelector(this.config.selectors.modal);if($)$.showModal();else this.showPaymentRetryModal()})}async setupPaymentRetryForm(Q){let X=document.querySelector("#keap-payment-method");if(!X){console.error("Payment method element not found in dialog");return}if(X.setAttribute("key",Q),!document.querySelector('script[src="https://payments.keap.page/lib/payment-method-embed.js"]')){let Y=document.createElement("script");Y.src="https://payments.keap.page/lib/payment-method-embed.js",document.body.appendChild(Y)}let W=document.querySelector(this.config.selectors.modalSubmitButton);if(W)W.addEventListener("click",()=>this.handlePaymentRetrySubmit());this.setupPaymentRetryMessageHandler()}setupPaymentRetryMessageHandler(){window.removeEventListener("message",this.handlePaymentMessage),this.handlePaymentMessage=async(Q)=>{let X=Q.data;if(!X||typeof X!=="object"||!("success"in X))return;if(console.log("Payment message received:",X),this.paymentResponseTimeout)clearTimeout(this.paymentResponseTimeout),this.paymentResponseTimeout=null;let W=document.querySelector(this.config.selectors.modalSubmitButton);if(W)W.disabled=!0,W.textContent="Processing...",W.style.cursor="not-allowed",W.style.opacity="0.7";this.disableAllAcceptButtons();let Y=document.querySelector(this.config.selectors.modal),Z="Your credit card was declined, please update your card.",_=Y?.querySelector("h2");if(_)Z=_.textContent||Z;if(!X.success){console.error("Payment method submission failed:",X),this.restoreModalState(Y,Z,W),this.enableAllAcceptButtons();return}window.removeEventListener("message",this.handlePaymentMessage);try{if(this.pendingProductId!==null){if(_)_.textContent="Processing your payment...";let $=Y?.querySelector("#keap-payment-method-container");if($ instanceof HTMLElement)$.style.opacity="0.5",$.style.pointerEvents="none";if(window._simulatePaymentDeclineEnabled=!1,typeof window._simulateRetryPaymentConfig!=="undefined")window._simulateRetryPaymentConfig=void 0;if(console.log("%c⚠️ PAYMENT RETRY: All simulations disabled for retry attempt","color: orange; font-weight: bold"),await this.processPaymentWithMethodId(X.paymentMethodId,this.pendingProductId),_)_.textContent="Payment successful!"}else console.error("No pending product ID found for payment retry"),this.restoreModalState(Y,Z,W),this.enableAllAcceptButtons()}catch($){console.error("Payment retry failed:",$),this.restoreModalState(Y,Z,W),this.enableAllAcceptButtons()}},window.addEventListener("message",this.handlePaymentMessage)}async handlePaymentRetrySubmit(){console.log("Submitting payment retry form");let Q=document.querySelector(this.config.selectors.modalSubmitButton);if(Q)Q.disabled=!0,Q.textContent="Processing...",Q.style.cursor="not-allowed",Q.style.opacity="0.7";this.disableAllAcceptButtons();let X=document.querySelector(this.config.selectors.modal),W="Your credit card was declined, please update your card.",Y=X?.querySelector("h2");if(Y)W=Y.textContent||W,Y.textContent="Processing your payment...";if(window._simulateRetryPaymentConfig?.enabled){console.log("%c\uD83D\uDD27 TESTING: Simulating payment retry submission...","color: purple"),setTimeout(()=>{if(window._simulateRetryPaymentConfig?.shouldSucceed||!1){if(console.log("%c\uD83D\uDD27 TESTING: Simulating SUCCESSFUL payment retry","color: green"),X)X.close();window._simulateRetryPaymentConfig=void 0,console.log("%c✅ TESTING: Payment retry successful! In real usage, the user would be redirected to the next step.","color: green; font-weight: bold"),this.enableAllAcceptButtons()}else console.log("%c\uD83D\uDD27 TESTING: Simulating FAILED payment retry","color: red"),this.restoreModalState(X,W,Q),this.enableAllAcceptButtons(),console.log("%c❌ TESTING: Payment retry failed! The modal has been reset to try again.","color: red; font-weight: bold")},3000);return}let Z=document.querySelector("#keap-payment-method");if(!Z||!Z.submit){console.error("Payment method element not ready"),this.restoreModalState(X,W,Q),this.enableAllAcceptButtons();return}this.paymentResponseTimeout=setTimeout(()=>{console.warn("No payment response received after 5 seconds"),this.restoreModalState(X,W,Q),this.enableAllAcceptButtons()},5000),Z.submit()}disableButton(Q,X){let W=X.querySelector(".elButtonMain");if(W instanceof HTMLElement)X.dataset.originalText=W.textContent||"",W.textContent="Processing...";X.dataset.originalBgColor=X.style.background,X.style.background="rgba(200, 200, 200, 0.7)",Q.style.pointerEvents="none",X.style.pointerEvents="none",X.style.opacity="0.7",X.style.cursor="default",X.classList.add("disabled")}disableAllAcceptButtons(){[this.config.selectors.acceptButton,this.config.selectors.acceptButton2,this.config.selectors.acceptButtonProduct2].forEach((X)=>{let W=document.getElementById(X);if(W){let Y=W.querySelector("a");if(Y instanceof HTMLElement)this.disableButton(W,Y)}})}enableAllAcceptButtons(){[this.config.selectors.acceptButton,this.config.selectors.acceptButton2,this.config.selectors.acceptButtonProduct2].forEach((X)=>{let W=document.getElementById(X);if(W){let Y=W.querySelector("a");if(Y instanceof HTMLElement){if(W.style.pointerEvents="",Y.style.pointerEvents="",Y.style.opacity="",Y.style.cursor="",Y.classList.remove("disabled"),Y.dataset.originalBgColor)Y.style.background=Y.dataset.originalBgColor;else Y.style.background="";let Z=Y.querySelector(".elButtonMain");if(Z instanceof HTMLElement){if(Y.dataset.originalText)Z.textContent=Y.dataset.originalText}}}})}restoreModalState(Q,X,W){if(Q){let Y=Q.querySelector("h2");if(Y)Y.textContent=X}if(W)W.disabled=!1,W.textContent="Click To Continue"}}if(G)new A().init();else console.log("Keap OTO script loaded in non-browser environment. DOM manipulation skipped.");
