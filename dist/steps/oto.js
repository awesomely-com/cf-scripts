var Y=typeof document!=="undefined"&&typeof window!=="undefined";function Z(q){q=q.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");let C=new RegExp("[\\?&]"+q+"=([^&#]*)").exec(window.location.search);return C===null?"":decodeURIComponent(C[1].replace(/\+/g," "))}function j(){return window.location.search.substring(1).split("&").reduce((A,C)=>{if(!C)return A;let[E,G]=C.split("=");return A[decodeURIComponent(E)]=decodeURIComponent(G||""),A},{})}function _(){console.log("URL debugging:",{fullUrl:window.location.href,protocol:window.location.protocol,hostname:window.location.hostname,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash});let q=window.location.pathname.replace(/^\/|\/$/g,"");if(!q)return"home";let C=(q.split("/").pop()||"").replace(/[^a-zA-Z0-9]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");return console.log("Generated page slug:",C||"home"),C||"home"}function F(q){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(q)}function R(q,A){let C={...q};if(!A)return C;return Object.keys(A).forEach((E)=>{let G=C[E],J=A[E];if(Array.isArray(G)&&Array.isArray(J))C[E]=[...new Set([...G,...J])];else if(typeof G==="object"&&G!==null&&typeof J==="object"&&J!==null&&!Array.isArray(G)&&!Array.isArray(J))C[E]=R(G,J);else if(J!==void 0)C[E]=J}),C}class ${config;state;initialized=!1;static defaultConfig={selectors:{acceptButton:"#tmp_button-11126-188",acceptButton2:"#tmp_button-79590-119",acceptButtonProduct2:"#product-2-button",rejectButton:"#link-94268",paymentContainer:"#payment-container"},sessionConfig:{expirationHours:2,storageKey:"orderSession"}};constructor(){this.config=R($.defaultConfig,window.KeapOTOConfig||{}),this.state={keapContactId:null,orderId:null,sessionKey:null,urlFriendlySessionKey:null,acceptUrl:null,rejectUrl:null,existingPaymentMethodId:null,stepProducts:null,primaryProductId:null,secondaryProductId:null,contactId:null}}init(){if(this.initialized=!1,Y)document.addEventListener("DOMContentLoaded",()=>{this.checkSessionKey(),this.setupButtonHandlers(),this.initialized=!0});else console.log("Not running in browser environment. Initialization skipped.")}isSessionExpired(q){let A=this.config.sessionConfig.expirationHours*60*60*1000;return new Date().getTime()-q>A}deleteExpiredSessionData(){try{localStorage.removeItem(this.config.sessionConfig.storageKey),sessionStorage.removeItem(this.config.sessionConfig.storageKey),console.log("Deleted expired order session from storage")}catch(q){console.warn("Failed to delete expired order session from storage",q)}}getOrderSession(){let q=null;try{let A=localStorage.getItem(this.config.sessionConfig.storageKey);if(A)q=JSON.parse(A);if(!q||this.isSessionExpired(q.timestamp||0)){let C=sessionStorage.getItem(this.config.sessionConfig.storageKey);if(C)q=JSON.parse(C)}if(q&&this.isSessionExpired(q.timestamp||0))return console.log("Order session expired",q),this.deleteExpiredSessionData(),null;return q}catch(A){return console.warn("Failed to retrieve order session from storage",A),null}}saveOrderSession(q){let A={...q,timestamp:new Date().getTime()};try{localStorage.setItem(this.config.sessionConfig.storageKey,JSON.stringify(A)),sessionStorage.setItem(this.config.sessionConfig.storageKey,JSON.stringify(A)),console.log("Order session saved to storage",A)}catch(C){console.warn("Failed to save order session to storage",C)}}checkSessionKey(){let q=Z("session_key"),A=this.getOrderSession();if(this.state.sessionKey=q||(A?A.sessionKey:null),this.state.contactId=A?A.contactId:null,!this.state.sessionKey){console.error("No session key found. Upsell page requires a session key."),alert("Session not found. Please return to the main order page.");return}let C=_();this.fetchPageData(C)}async fetchPageData(q){try{let A=await fetch("https://funnels-api.awesomely.com/api/keap/start-payments-api-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({page_slug:q,session_key:this.state.sessionKey})});if(!A.ok){if(A.status===400){let E=await A.json();if(E.message==="Session has expired")console.log("Received expired session error from API"),this.deleteExpiredSessionData();throw new Error("Network response was not ok: "+E.message)}throw new Error("Network response was not ok: "+A.statusText)}let C=await A.json();if(console.log("API Response:",C),C.is_duplicate===!0){if(console.warn("Duplicate order detected"),C.step&&C.step.next_step_url)setTimeout(()=>{window.location.href=C.step.next_step_url+"?session_key="+(C.order?.url_friendly_session_key||this.state.sessionKey||"")},3000);return}this.updateState(C)}catch(A){console.error("API request failed:",A)}}updateState(q){if(q.contact&&q.contact.id)this.state.keapContactId=q.contact.id.toString();if(q.order)this.state.orderId=q.order.id.toString(),this.state.sessionKey=q.order.session_key,this.state.urlFriendlySessionKey=q.order.url_friendly_session_key;if(q.step)this.state.acceptUrl=q.step.next_step_url,this.state.rejectUrl=q.step.rejected_step_url;if(q.payment&&q.payment.payment_method_id)this.state.existingPaymentMethodId=q.payment.keap_payment_method_id,console.log("Found existing payment method ID:",this.state.existingPaymentMethodId);if(q.step&&q.step.products){this.state.stepProducts=q.step.products;let A=this.state.stepProducts?.find((E)=>E.position==="primary"),C=this.state.stepProducts?.find((E)=>E.position==="secondary");this.state.primaryProductId=A?A.id:null,this.state.secondaryProductId=C?C.id:null}}setupButtonHandlers(){let q=document.getElementById(this.config.selectors.acceptButton);if(q){let G=q.querySelector("a");if(G instanceof HTMLElement)G.addEventListener("click",(J)=>{J.preventDefault(),this.disableButton(q,G),this.handleAcceptClick()});else console.error("Primary accept button link not found within:",this.config.selectors.acceptButton)}else console.error("Primary accept button with ID",this.config.selectors.acceptButton,"not found");let A=document.getElementById(this.config.selectors.acceptButton2);if(A){let G=A.querySelector("a");if(G instanceof HTMLElement)G.addEventListener("click",(J)=>{J.preventDefault(),this.disableButton(A,G),this.handleAcceptClick()});else console.error("Secondary accept button link not found within:",this.config.selectors.acceptButton2)}else console.warn("Secondary accept button with ID",this.config.selectors.acceptButton2,"not found - this is optional");let C=document.getElementById(this.config.selectors.acceptButtonProduct2);if(C){let G=C.querySelector("a");if(G instanceof HTMLElement)G.addEventListener("click",(J)=>{J.preventDefault(),this.disableButton(C,G),this.handleProduct2AcceptClick()});else console.error("Second product accept button link not found within:",this.config.selectors.acceptButtonProduct2)}else console.warn("Second product accept button with ID",this.config.selectors.acceptButtonProduct2,"not found - this is optional");let E=document.getElementById(this.config.selectors.rejectButton);if(E)E.addEventListener("click",()=>{this.handleRejectClick()});else console.error("Reject button with ID",this.config.selectors.rejectButton,"not found")}handleAcceptClick(){this.processPayment(this.state.primaryProductId)}handleProduct2AcceptClick(){this.processPayment(this.state.secondaryProductId)}handleRejectClick(){let q=`?session_key=${this.state.urlFriendlySessionKey||""}`;if(this.state.rejectUrl)window.location.href=this.state.rejectUrl+q;else if(console.warn("No reject URL found"),this.state.acceptUrl)window.location.href=this.state.acceptUrl+q;else alert("Error: Could not determine the next page. Please contact support.")}processPayment(q){if(!q){console.error("No product ID provided for payment processing");return}if(this.state.existingPaymentMethodId){console.log("Using existing payment method ID:",this.state.existingPaymentMethodId),this.processPaymentWithMethodId(this.state.existingPaymentMethodId,q);return}console.error("No payment method ID found for this session")}async processPaymentWithMethodId(q,A){let C=_(),E=[];if(A!==null)E.push(A);else if(this.state.primaryProductId!==null)E.push(this.state.primaryProductId);else if(this.state.stepProducts&&Array.isArray(this.state.stepProducts)&&this.state.stepProducts.length>0)E.push(this.state.stepProducts[0].id);if(E.length===0){console.error("No products found to add to the order");return}let G=Z("affiliate"),J={contact_id:this.state.keapContactId,payment_method_id:q,session_key:this.state.sessionKey,page_slug:C,product_ids:E};if(G)J.affiliate_id=G;try{let Q=await fetch("https://funnels-api.awesomely.com/api/keap/create-and-charge-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(J)});if(!Q.ok){if(Q.status===400){let z=await Q.json();if(z.message==="Session expired")console.log("Session expired during payment process"),this.deleteExpiredSessionData();throw new Error("Network response was not ok: "+z.message)}throw new Error("Network response was not ok: "+Q.statusText)}let N=await Q.json();console.log("Order created:",N);let X=`?session_key=${this.state.urlFriendlySessionKey||""}`;if(N.is_duplicate===!0){if(console.warn("Duplicate order detected"),N.next_step_url)setTimeout(()=>{window.location.href=N.next_step_url+X},3000);else if(N.step&&N.step.next_step_url)setTimeout(()=>{window.location.href=N.step.next_step_url+X},3000);return}let W=null;if(N.next_step_url)W=N.next_step_url;else if(N.step&&N.step.next_step_url)W=N.step.next_step_url;else if(this.state.acceptUrl)W=this.state.acceptUrl;if(W)setTimeout(()=>{window.location.href=W+X},3000);else console.warn("No next step URL found")}catch(Q){console.error("API request failed:",Q)}}disableButton(q,A){let C=A.querySelector(".elButtonMain");if(C instanceof HTMLElement)A.dataset.originalText=C.textContent||"",C.textContent="Processing...";A.dataset.originalBgColor=A.style.background,A.style.background="rgba(200, 200, 200, 0.7)",q.style.pointerEvents="none",A.style.pointerEvents="none",A.style.opacity="0.7",A.style.cursor="default",A.classList.add("disabled")}}if(Y)new $().init();else console.log("Keap OTO script loaded in non-browser environment. DOM manipulation skipped.");
